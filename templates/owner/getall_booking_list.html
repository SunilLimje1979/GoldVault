<!-- <!doctype html>
{% load static %}
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bookings</title>
    <meta name="keywords" content="bootstrap, wallet, banking, fintech mobile template, cordova, phonegap, mobile, html, responsive" />
    <link rel="icon" type="image/png" href="{% static 'assets/img/favicon.png' %}" sizes="32x32">
    <link rel="stylesheet" href="/static/assets/css/style.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/ionicons@latest/dist/ionicons/ionicons.esm.js"></script>
</head>
<body>

<div class="appHeader">
    <div class="left">
        <a href="{% url 'dashboard' %}" class="headerButton goBack">
            <ion-icon name="chevron-back-outline"></ion-icon>
        </a>
    </div>
    <div class="pageTitle" style="font-family:Poppins,sans-serif;">Bookings</div>
    <div class="right"></div>
</div>

<div id="appCapsule">

    {% if error %}
        <div class="section mt-2">
            <div class="alert alert-danger">{{ error }}</div>
        </div>
    {% else %}
        
        <div class="section mt-2" style="display:flex; gap:8px; align-items:center;">
            <form method="get" action="{% url 'get_booking_list' %}" style="display:flex; width:100%; gap:6px;">
                <input type="date" name="date" value="{{ request.GET.date|default:'' }}" 
                    style="flex:1; padding:8px; border:1px solid #ccc; border-radius:8px;">
                <button type="submit" 
                    style="padding:8px 12px; border:none; border-radius:8px; background:#edc88f; color:black; font-weight:bold; white-space:nowrap;">
                    Submit
                </button>
            </form>
        </div>

        
        <div class="section mt-2">
            <input type="text" id="memberSearch" placeholder="Search by name or mobile..."
                style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; margin-bottom:15px;">
        </div>

        
        {% for status, records in bookings.items %}
        <div class="section mt-2 booking-section">
            <div class="section-title">{{ status }}</div>
            <div class="card" style="padding:0;">
                <ul class="listview flush transparent no-line image-listview detailed-list mt-1 mb-1">
                    {% if records %}
                        {% for b in records %}
                        <li class="booking-card">
                            <a href="#" class="item">
                                <div class="icon-box bg-primary">
                                    <ion-icon name="cube-outline"></ion-icon>
                                </div>
                                <div class="in">
                                    <div>
                                        <strong class="user-name">{{ b.UserFullName }}</strong>
                                        <div class="text-small text-secondary user-mobile">{{ b.UserMobileNo }}</div>
                                    </div>
                                    <div class="text-end">
                                        <strong>{{ b.BookingWeight }} g</strong>
                                        <div class="text-small">₹ {{ b.BookingAmount }}</div>
                                    </div>
                                </div>
                            </a>
                        </li>
                        {% endfor %}
                    {% else %}
                        <li style="padding:12px; text-align:center; color:#888;">
                            No records found.
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
        {% endfor %}
    {% endif %}

</div>


<script>
document.getElementById("memberSearch").addEventListener("input", function() {
    let filter = this.value.toLowerCase();
    let sections = document.querySelectorAll(".booking-section");

    sections.forEach(section => {
        let cards = section.querySelectorAll(".booking-card");
        let matchFound = false;

        cards.forEach(card => {
            let name = card.querySelector(".user-name").innerText.toLowerCase();
            let mobile = card.querySelector(".user-mobile").innerText.toLowerCase();
            if (name.includes(filter) || mobile.includes(filter)) {
                card.style.display = "";
                matchFound = true;
            } else {
                card.style.display = "none";
            }
        });

        // Hide section if no match
        section.style.display = matchFound || filter === "" ? "" : "none";
    });
});
</script>

</body>
</html> -->
<!doctype html>
{% load static %}
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bookings</title>
    <link rel="icon" type="image/png" href="{% static 'assets/img/favicon.png' %}" sizes="32x32">
    <link rel="stylesheet" href="/static/assets/css/style.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/ionicons@latest/dist/ionicons/ionicons.esm.js"></script>
</head>
<body>
<!-- loader -->
<div id="loader" style="display: none;">
    <img src="{% static 'assets/img/loading-icon.png' %}" alt="icon" class="loading-icon">
</div>
<div class="appHeader">
    <div class="left">
        <a href="{% url 'dashboard' %}" class="headerButton goBack">
            <ion-icon name="chevron-back-outline"></ion-icon>
        </a>
    </div>
    <div class="pageTitle" style="font-family:Poppins,sans-serif;">Bookings</div>
    <div class="right"></div>
</div>

<div id="appCapsule">

    {% if error %}
        <div class="section mt-2">
            <div class="alert alert-danger">{{ error }}</div>
        </div>
    {% else %}
        <!-- 📅 Date + icons row -->
        <div class="section mt-2" style="display:flex; gap:8px; align-items:center;">
            <form method="get" action="{% url 'get_booking_list' %}" style="display:flex; flex:1; gap:6px; align-items:center;">
                <input type="date" name="date" value="{{ date|default:'' }}" 
                    style="flex:1; padding:6px; border:1px solid #ccc; border-radius:8px;">
                <!-- 🔍 Search icon -->
                <button type="submit" style="background:none; border:none; cursor:pointer;">
                    <ion-icon name="search-outline" style="font-size:22px; color:#edc88f;"></ion-icon>
                </button>
            </form>
            <!-- 🔄 Refresh -->
            <a href="{% url 'get_booking_list' %}" style="text-decoration:none;">
                <ion-icon name="refresh-outline" style="font-size:22px; color:#edc88f;"></ion-icon>
            </a>
            <!-- ⚙️ Filter (toggles search bar) -->
            <a href="javascript:void(0);" onclick="toggleSearch()" style="text-decoration:none;">
                <ion-icon name="filter-outline" style="font-size:22px; color:#edc88f;"></ion-icon>
            </a>
        </div>

        <!-- 🔎 Search Box (hidden by default) -->
        <div class="section mt-2" id="searchBox" style="display:none; transition:all 0.3s ease;">
            <input type="text" id="memberSearch" placeholder="Search by name or mobile..."
                style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; margin-bottom:15px;">
        </div>

        <!-- 📌 Booking sections -->
        {% for status, records in bookings.items %}
        <div class="section mt-2 booking-section">
            <!-- <div class="section-title" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="toggleSection(this)">
                {{ status }}
                <ion-icon name="chevron-down-outline" style="transition:transform 0.2s;"></ion-icon>
            </div> -->
            <div class="section-title" 
                style="display:flex; align-items:center; gap:6px; cursor:pointer;" 
                onclick="toggleSection(this)">
                <span>{{ status }}</span>
                <ion-icon name="chevron-down-outline" style="transition:transform 0.2s;"></ion-icon>
            </div>

            <div class="card section-content" style="padding:0;">
                <ul class="listview flush transparent no-line image-listview detailed-list mt-1 mb-1">
                    {% if records %}
                        {% for b in records %}
                        <li class="booking-card"
                        data-bookingid="{{ b.BookingId }}"
                        data-usercode="{{b.UserCode}}"
                        data-productid="{{ b.ProductId }}"
                        data-name="{{ b.UserFullName }}"
                        data-mobile="{{ b.UserMobileNo }}"
                        data-date="{{ b.BookingDateTime }}"
                        data-weight="{{ b.BookingWeight }}"
                        data-amount="{{ b.BookingAmount }}"
                        data-orderstatus="{{ b.OrderStatus }}"
                        data-OrderId="{{ b.OrderId }}">
                            <a href="#" onclick="event.preventDefault();" class="item">
                                <div class="icon-box bg-primary">
                                    <ion-icon name="cube-outline"></ion-icon>
                                </div>
                                <div class="in">
                                    <div>
                                        <strong class="user-name">{{ b.UserFullName }}</strong>
                                        <div class="text-small text-secondary user-mobile">{{ b.UserMobileNo }}</div>
                                    </div>
                                    <div class="text-end">
                                        <strong>{{ b.BookingWeight }} g</strong>
                                        <div class="text-small">₹ {{ b.BookingAmount }}</div>
                                    </div>
                                </div>
                            </a>
                        </li>
                        {% endfor %}
                    {% else %}
                        <li style="padding:12px; text-align:center; color:#888;">
                            No {{ status }} Bookings found.
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
        {% endfor %}
    {% endif %}

</div>

<!-- 📌 Booking Modal -->
<div id="bookingModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:9999;">
    <div style="background:#fff; padding:20px; border-radius:12px; width:90%; max-width:400px; color:#000; font-weight:bold;">
        <h3 style="margin-bottom:15px;">Booking Detail</h3>
        <p><strong>Name:</strong> <span id="bModalName"></span></p>
        <p><strong>Mobile:</strong> <span id="bModalMobile"></span></p>
        <p><strong>Booking Date:</strong> <span id="bModalDate"></span></p>
        <p><strong>Weight:</strong> <span id="bModalWeight"></span> g</p>
        <p><strong>Amount:</strong> ₹ <span id="bModalAmount"></span></p>
        <p><strong>Order ID:</strong> <span id="bModalOrderId"></span></p>
        <p><strong>Status:</strong> <span id="bModalStatus"></span></p>

        <!-- Hidden IDs -->
        <input type="hidden" id="bModalBookingId">
        <input type="hidden" id="bModalUserCode">
        <input type="hidden" id="bookingOrderId">


        <!-- Action Buttons -->
        <div id="bActionButtons" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:15px;">
            <button id="bApproveBtn" style="flex:1; padding:10px; background:#28a745; color:#fff; border:none; border-radius:8px;">Approve</button>
            <button id="bRejectBtn" style="flex:1; padding:10px; background:#dc3545; color:#fff; border:none; border-radius:8px;">Reject</button>
            <button id="bOkBtn" style="flex:1; padding:10px; background:#007bff; color:#fff; border:none; border-radius:8px; display:none;">Ok</button>
        </div>

        <button id="bCloseModal" style="margin-top:15px; width:100%; padding:10px; background:#6c757d; color:#fff; border:none; border-radius:8px;">Close</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- 🔎 JS -->
<script>
function toggleSearch() {
    let box = document.getElementById("searchBox");
    box.style.display = (box.style.display === "none" || box.style.display === "") ? "block" : "none";
}

// Section toggle
function toggleSection(titleEl) {
    let icon = titleEl.querySelector("ion-icon");
    let content = titleEl.nextElementSibling;
    if (content.style.display === "none") {
        content.style.display = "block";
        icon.setAttribute("name", "chevron-down-outline");
    } else {
        content.style.display = "none";
        icon.setAttribute("name", "chevron-forward-outline"); // › closed
    }
}

// Search filter
document.getElementById("memberSearch")?.addEventListener("input", function() {
    let filter = this.value.toLowerCase();
    let sections = document.querySelectorAll(".booking-section");

    sections.forEach(section => {
        let cards = section.querySelectorAll(".booking-card");
        let matchFound = false;

        cards.forEach(card => {
            let name = card.querySelector(".user-name").innerText.toLowerCase();
            let mobile = card.querySelector(".user-mobile").innerText.toLowerCase();
            if (name.includes(filter) || mobile.includes(filter)) {
                card.style.display = "";
                matchFound = true;
            } else {
                card.style.display = "none";
            }
        });

        section.style.display = matchFound || filter === "" ? "" : "none";
    });
});
</script>

<script>
$(document).ready(function(){
    // Open modal on booking card click
    $(".booking-card").on("click", function(){
        let record = $(this).data();
        // console.log(record);
        $("#bModalBookingId").val(record.bookingid);
        $("#bModalUserCode").val(record.usercode);
        $("#bookingOrderId").val(record.orderid);
        $("#bModalName").text(record.name);
        $("#bModalMobile").text(record.mobile);
        $("#bModalDate").text(record.date);
        $("#bModalWeight").text(record.weight);
        $("#bModalAmount").text(record.amount);
        $("#bModalOrderId").text(record.orderid);

        // Set status text
        let statusText = "Pending";
        if(record.orderstatus == "1") statusText = "Pending";
        else if(record.orderstatus == "2") statusText = "Approved";
        else if(record.orderstatus == "3") statusText = "Rejected";
        $("#bModalStatus").text(statusText);

        // Reset buttons
        $("#bApproveBtn, #bRejectBtn, #bOkBtn, #bCloseModal").hide();

        // Show buttons based on status
        if(record.orderstatus == "0"){ 
            $("#bApproveBtn").text("Approve").show();
            $("#bRejectBtn").text("Reject").show();
            $("#bCloseModal").show();
        }
        else if(record.orderstatus == "1"){ 
            // $("#bApproveBtn").text("Deliver").show();
            // $("#bRejectBtn").text("Reject").show();
            $("#bApproveBtn").text("Approve").show();
            $("#bRejectBtn").text("Reject").show();
            $("#bCloseModal").show();
        }
        else if(record.orderstatus == "2" || record.orderstatus == "3"){ 
            $("#bOkBtn").show();
        }

        $("#bookingModal").css("display","flex");
    });

    // Close modal
    $("#bCloseModal, #bOkBtn").on("click", function(){
        $("#bookingModal").hide();
    });

    // Approve/Reject/Deliver via AJAX
    $("#bApproveBtn, #bRejectBtn").on("click", function(){
        document.getElementById('loader').style.display = 'flex';
        var action = $(this).text().toLowerCase(); // approve / reject / deliver
        var bookingId = $("#bModalBookingId").val();
        // var productId = $("#bModalProductId").val();
        var UserCode = $("#bModalUserCode").val();
        var OrderId = $("#bookingOrderId").val();

        $.ajax({
            url: "{% url 'update_booking_status' %}",
            type: "POST",
            data: {
                "booking_id": bookingId,
                "action": action,
                "UserCode":UserCode,
                "OrderId":OrderId,
                "csrfmiddlewaretoken": "{{ csrf_token }}"
            },
            success: function(resp){
                if(resp.success){
                    alert(resp.message);
                    location.reload();
                } else {
                    alert("Error: " + resp.message);
                    location.reload();
                }
            },
            error: function(){
                alert("Something went wrong.");
                location.reload();
            }
        });
    });
});
</script>

</body>
</html>
